worker_processes 4;
pid /home/melpa/var/run/nginx2.pid;
daemon off;

events {
	worker_connections 768;
}

http {
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;
	server_tokens off;

	# server_names_hash_bucket_size 64;

	charset utf-8;
	
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	#access_log  /home/melpa/log/melpa.access.log combined;
	#error_log  /home/melpa/log/melpa.error.log info;
	access_log  /home/melpa/test.melpa.access.log combined;
	error_log  /home/melpa/test.melpa.error.log info;

	chunked_transfer_encoding off;
	
	gzip on;
	gzip_disable "msie6|Emacs";
	
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/xhtml text/css text/js text/csv application/javascript application/x-javascript application/json application/xml text/xml application/atom+xml application/rss+xml;

	client_max_body_size       10m;
	client_body_buffer_size    128k;

	server {
		server_name melpa-stable.milkbox.net;
		server_name hiddencameras.milkbox.net;
		rewrite ^ $scheme://stable.melpa.org$request_uri? permanent;
	}
	
	server {
		listen  80;
		listen	443 ssl;
	
	        server_name localhost stable.melpa.org;

		root /home/melpa/melpa/html;
	
	        ssl_certificate /etc/letsencrypt/live/stable.melpa.org/fullchain.pem;
	        ssl_certificate_key /etc/letsencrypt/live/stable.melpa.org/privkey.pem;
	
		# Lock down ciphers / SSL versions to attain a good security rating
		# https://www.ssllabs.com/ssltest/analyze.html?d=melpa.org
		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
		ssl_ciphers 'kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !MD5 !EXP !DSS !PSK !SRP !kECDH !CAMELLIA !RC4 !SEED';
		ssl_prefer_server_ciphers on;
	
	        location ~ /.well-known {
	                allow all;
			root /usr/share/nginx/html;
	        }
	
		error_page   500 502 503 504  /50x.html;
		location = /50x.html {
			root   /var/www/nginx-default;
		}
		location = /packages/archive-contents {
			default_type text/plain;
		}
		location ~ ^/packages/.*\.el {
			default_type text/plain;
		}
		location ~ ^/packages/.*\.svg {
			add_header Cache-Control no-cache;
		}
	}
}

